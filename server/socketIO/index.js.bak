module.exports = function (server, callback) {
  const io = require("socket.io")(server);

  const connectedClients = new Map();
  const getKeyByValue = require("../util/getKeyByValue.js");

  io.on("connection", (socket) => {
    const socketID = socket.id;
    const clientName = socket.handshake.headers.client;
    console.log("a client is connected. client's socket id is: " + socketID);

    connectedClients.set(clientName, { socketID });
    console.log(
      "New connected socket is: ",
      getKeyByValue(connectedClients, { socketID })
    );
    console.log("All connected clients are: ", connectedClients);

    socket.on("chat message", (message) => {
      const { content, from, to } = message;
      console.log(
        "incoming message: " +
          content +
          " from " +
          from +
          " to " +
          to +
          ` through socket: ${socket.id}`
      );
      
      const receiver = connectedClients.get(to);
      switch (receiver) {
        // asynchronous chatting
        case undefined:
          console.log(`receiver ${to} is offline`);
          break;
        // synchronous chatting
        default:
          console.log(`sending message to socket: ${receiver.socketID}`);
          io.to(receiver.socketID).emit("chat message", message);

          break;
      }
    });

    // A connection is automatically terminated if client has refreshed. probably in _idleTimeout: 45000ms?.
    // server-side reload/refresh will just reload the service, empty the connectedClients sets
    // and re-map existing connection with a new socket object.

    // handle idle sockets on server-side refresh/reload later
    socket.on("disconnect", (reason) => {
      console.log(reason, socketID + " is closed.");
      // manual disconnection from be seems unnecessary
      // socket.disconnect();
      const disconnectingUser = getKeyByValue(connectedClients, { socketID });
      connectedClients.delete(disconnectingUser);
      console.log(`client ${disconnectingUser} is disconnected.`);
      console.log("connected clients are: ", connectedClients);
    });
  });
};
